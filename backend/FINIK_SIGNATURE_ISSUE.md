# Почему Finik возвращает «An invalid signature is provided»

## Что происходит

1. **Мы делаем:** перед отправкой запроса к Finik мы собираем строку из метода, пути, заголовков и тела, подписываем её **приватным ключом** (RSA-SHA256) и кладём подпись в заголовок `signature`.

2. **Finik делает:** получает запрос, собирает у себя **такую же** строку из метода, пути, заголовков и тела, и проверяет подпись **вашим публичным ключом**. Если строка совпадает — подпись верная. Если нет — возвращает 401 «invalid signature».

3. **Проблема:** наша строка и строка Finik **чем-то отличаются**. Даже лишний пробел, другой порядок полей в JSON или другой набор заголовков даёт другую подпись, и проверка не проходит.

## Что мы уже пробовали

- С заголовком `Host` в подписи и без него
- С пробелом после двоеточия в заголовках и без
- Тело запроса как «как есть» (JSON.stringify) и как канонический JSON (сортировка ключей)
- Нормализация приватного ключа из .env (`\n` → перевод строки)

Ошибка остаётся — значит, у Finik другой формат канонической строки, и его нет в открытой документации.

## Что сделать с вашей стороны

Написать в поддержку Finik (или вашему менеджеру Айжан) и попросить **одно из двух**:

1. **Точное описание алгоритма подписи:** из чего собирается строка для подписи (построчно: метод, путь, заголовки, тело) и в каком формате (порядок заголовков, пробелы, формат JSON тела).

2. **Рабочий пример на Node.js** — например, скрипт или ссылка на репозиторий, который создаёт платёж и успешно проходит проверку подписи. Тогда мы сможем повторить тот же формат у себя.

Можно также спросить, используют ли они пакет `@mancho.devs/authorizer` из документации и доступен ли он в npm — тогда мы подключим его и будем подписывать так же.

## Включить отладочный лог (по желанию)

В `backend/.env` добавьте:

```env
FINIK_DEBUG_SIGNATURE=1
```

После этого при создании платежа в логах бэкенда будет выведена строка, которую мы подписываем (API key замазан). Эту строку можно отправить в Finik и попросить подтвердить, совпадает ли их каноническая строка с этой.
